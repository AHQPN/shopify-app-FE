{% assign is_in_wishlist = false %}
{% assign wishlist_json = '[]' %}

{% if customer %}
  {% assign wishlist_value = customer.metafields.custom.wishlist.value %}
  {% if wishlist_value %}
    {% assign current_variant = product.selected_or_first_available_variant %}
    {% for item in wishlist_value %}
      {% if item.id == current_variant.id %}
        {% assign is_in_wishlist = true %}
      {% endif %}
    {% endfor %}

    {% capture wishlist_gids %}[{% for item in wishlist_value %}"gid://shopify/ProductVariant/{{ item.id }}"{% unless forloop.last %},{% endunless %}{% endfor %}]{% endcapture %}
    {% assign wishlist_json = wishlist_gids | strip_newlines %}
  {% endif %}
{% endif %}

<div class="wishlist-block-container" {{ block.shopify_attributes }}>
  <button
    type="button"
    id="wishlist-inner-{{ section.id }}-{{ block.id }}-{{ product.id }}"
    class="wishlist-btn{% if is_in_wishlist %} is-active{% endif %}"
    aria-label="Add to Wishlist"
    data-product-id="{{ product.selected_or_first_available_variant.id }}"
    data-customer-id="{{ customer.id }}"
    data-is-logged-in="{% if customer %}true{% else %}false{% endif %}"
    data-login-url="{{ routes.account_login_url }}"
    data-require-login="{{ block.settings.require_login }}"
    data-shop="{{ shop.permanent_domain }}"
    data-initial-wishlist="{{ wishlist_json | escape }}"
  >
    <div class="wishlist-icon-wrapper">
      <svg
        class="icon-heart"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
    </div>
    {% if block.settings.show_text %}
      <span class="wishlist-text">
        {% if is_in_wishlist %}
          {{ block.settings.text_active }}
        {% else %}
          {{ block.settings.text }}
        {% endif %}
      </span>
    {% endif %}
  </button>
</div>

<style>
  .wishlist-block-container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    margin: 5px;
  }

  .wishlist-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: {{ block.settings.bg_color }};
    color: {{ block.settings.icon_color }};
    border: 1px solid {{ block.settings.border_color }};
    padding: {{ block.settings.padding_y }}px {{ block.settings.padding_x }}px;
    border-radius: {{ block.settings.border_radius }}px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    position: relative;
  }

  .wishlist-btn:hover {
    transform: scale(1.05);
    border-color: {{ block.settings.icon_color_active }};
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .wishlist-btn.is-active {
    color: {{ block.settings.icon_color_active }};
    border-color: {{ block.settings.icon_color_active }};
  }

  .wishlist-btn.is-active .icon-heart {
    fill: {{ block.settings.icon_color_active }};
    stroke: {{ block.settings.icon_color_active }};
    animation: heart-beat 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .wishlist-btn.is-loading {
    opacity: 0.7;
    cursor: wait;
  }

  .wishlist-btn.is-loading .icon-heart {
    animation: heart-pulse 1s infinite ease-in-out;
  }

  .wishlist-icon-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .wishlist-text {
    font-size: 14px;
    font-weight: 600;
  }

  @keyframes heart-beat {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }

  @keyframes heart-pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* Responsive tweaks */
  @media (max-width: 749px) {
    .wishlist-text {
      font-size: 12px;
    }
    .wishlist-btn {
      padding: 6px 12px;
    }
  }
</style>

<script>
  (function() {
    const btnId = 'wishlist-inner-{{ section.id }}-{{ block.id }}-{{ product.id }}';
    const btn = document.getElementById(btnId);
    
    // Config from similar blocks
    const API_URL = '/apps/ext/wishlist';

    async function fetchApi(endpoint, options = {}) {
      const url = endpoint.startsWith('http') ? endpoint : `${API_URL}${endpoint}`;
      const defaultHeaders = {
        'ngrok-skip-browser-warning': 'true',
      };
      const config = {
        ...options,
        headers: {
          ...defaultHeaders,
          ...options.headers,
        },
      };
      return fetch(url, config);
    }

    if (btn && !btn.dataset.initialized) {
      btn.dataset.initialized = 'true';
      
      const shop = btn.dataset.shop;

      // Helper to get most up-to-date variant ID (useful for PDP)
      const getActiveVariantId = () => {
        const activeInput = document.querySelector('form[action*="/cart/add"] input[name="id"]');
        if (activeInput && activeInput.value) return activeInput.value;
        return btn.dataset.productId;
      };

      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (this.classList.contains('is-loading')) return;

        // Login check
        const requireLogin = this.dataset.requireLogin === 'true';
        const isLoggedIn = this.dataset.isLoggedIn === 'true';
        
        if (requireLogin && !isLoggedIn) {
          window.location.href = this.dataset.loginUrl;
          return;
        }

        const shop = this.dataset.shop;
        const customerId = this.dataset.customerId;

        this.classList.add('is-loading');

        try {
          const isActive = this.classList.contains('is-active');
          const endpoint = isActive ? '/remove' : '/add';
          const currentId = getActiveVariantId();
          const variantGid = currentId.startsWith('gid://') ? currentId : `gid://shopify/ProductVariant/${currentId}`;

          // Standardize ID format for backend (numeric string)
          const cleanId = String(currentId).replace('gid://shopify/ProductVariant/', '').replace('gid://shopify/Product/', '');

          const res = await fetchApi(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              shop: shop,
              customerId: customerId,
              productId: cleanId
            })
          });

          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || 'Failed to update wishlist');
          }

          const json = await res.json();
          const updatedWishlist = (json.data || []).map(id => 
            String(id).startsWith('gid://') ? id : `gid://shopify/ProductVariant/${id}`
          );
          
          const newStatus = updatedWishlist.includes(variantGid);

          // Update this button and broadcast sync
          updateButtonState(this, newStatus);

          document.dispatchEvent(new CustomEvent('wishlist:sync', {
            detail: { productId: variantGid, isActive: newStatus }
          }));

        } catch (err) {
          console.error('[Wishlist Error]', err);
          alert(err.message);
        } finally {
          this.classList.remove('is-loading');
        }
      });
    }

    function updateButtonState(b, active) {
      if (!b) return;
      b.classList.toggle('is-active', active);
      const textSpan = b.querySelector('.wishlist-text');
      if (textSpan && {{ block.settings.show_text | json }}) {
        textSpan.textContent = active ? {{ block.settings.text_active | json }} : {{ block.settings.text | json }};
      }
    }
    
    // Sync listener - each instance updates itself using its own scope/settings
    document.addEventListener('wishlist:sync', function(e) {
      // Get current variant ID for this product context
      const currentVariantId = getActiveVariantId();
      const variantGid = currentVariantId.startsWith('gid://') ? currentVariantId : `gid://shopify/ProductVariant/${currentVariantId}`;
      const syncId = e.detail.productId.startsWith('gid://') ? e.detail.productId : `gid://shopify/ProductVariant/${e.detail.productId}`;
      
      if (syncId === variantGid && btn) {
        updateButtonState(btn, e.detail.isActive);
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Add to Wishlist",
  "target": "section",
  "enabled_on": {
    "templates": ["product", "collection", "index"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Privacy & Permissions"
    },
    {
      "type": "checkbox",
      "id": "require_login",
      "label": "Require login to wishlist",
      "default": true,
      "info": "Redirects anonymous users to the login page when they click the button."
    },
    {
      "type": "header",
      "content": "Text Settings"
    },
    {
      "type": "checkbox",
      "id": "show_text",
      "label": "Show Button Text",
      "default": true
    },
    {
      "type": "text",
      "id": "text",
      "label": "Default Text",
      "default": "Add to wishlist"
    },
    {
      "type": "text",
      "id": "text_active",
      "label": "Active Text",
      "default": "In wishlist"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Icon Color",
      "default": "#2c3e50"
    },
    {
      "type": "color",
      "id": "icon_color_active",
      "label": "Active Color (Heart & Text)",
      "default": "#ff6b6b"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#e5e5e5"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "range",
      "id": "padding_x",
      "label": "Horizontal Padding",
      "min": 10,
      "max": 40,
      "step": 2,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_y",
      "label": "Vertical Padding",
      "min": 4,
      "max": 20,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Corner Radius",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 50,
      "unit": "px"
    }
  ]
}
{% endschema %}
