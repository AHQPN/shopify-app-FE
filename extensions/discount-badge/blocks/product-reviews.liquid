{% comment %}
  Product Reviews Block
  Allows users to view and submit reviews.
  Requires Login for submission.
  Uses FontAwesome for icons.
{% endcomment %}

<!-- FontAwesome CDN -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
>

<style>
  /* Modal Styles */
  .review-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 9999;
    overflow-y: auto;
    animation: fadeIn 0.2s ease;
  }

  .review-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .review-modal-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideUp 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .review-modal-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: white;
    border-radius: 16px 16px 0 0;
    z-index: 1;
  }

  .review-modal-body {
    padding: 24px;
  }

  .modal-close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #6b7280;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
  }

  .modal-close-btn:hover {
    background: #f3f4f6;
    color: #111827;
  }

  .star-rating-input {
    display: flex;
    gap: 8px;
    flex-direction: row-reverse;
    justify-content: flex-end;
  }

  .star-rating-input input {
    display: none;
  }

  .star-rating-input label {
    cursor: pointer;
    color: #d1d5db;
    font-size: 32px;
    transition: all 0.2s;
  }

  .star-rating-input label:hover,
  .star-rating-input label:hover ~ label,
  .star-rating-input input:checked ~ label {
    color: #fbbf24 !important;
    transform: scale(1.1);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
    font-size: 14px;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s;
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-textarea {
    resize: vertical;
    min-height: 100px;
  }

  .file-upload-wrapper {
    position: relative;
  }

  .file-upload-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 20px;
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    background: #f9fafb;
    color: #6b7280;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .file-upload-label:hover {
    border-color: #3b82f6;
    background: #eff6ff;
    color: #3b82f6;
  }

  .file-upload-label.has-files {
    border-color: #10b981;
    background: #f0fdf4;
    color: #10b981;
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    padding: 12px 32px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 15px;
    transition: all 0.2s;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px -2px rgba(59, 130, 246, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .btn-secondary {
    background: white;
    color: #6b7280;
    border: 2px solid #e5e7eb;
    padding: 12px 32px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 15px;
    transition: all 0.2s;
  }

  .btn-secondary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  .reply-banner {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    color: #1e40af;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    border: 1px solid #bfdbfe;
  }

  .cancel-reply-btn {
    background: none;
    border: none;
    color: #1e40af;
    font-weight: 700;
    cursor: pointer;
    font-size: 18px;
    padding: 0 8px;
  }

  @media (max-width: 640px) {
    .review-modal-content {
      max-height: 100vh;
      border-radius: 0;
    }

    .review-modal-header {
      border-radius: 0;
    }
  }
</style>

<div
  id="app-product-reviews"
  data-product-id="{{ product.id }}"
  data-product-name="{{ product.title | escape }}"
  data-shop="{{ shop.permanent_domain }}"
  style="margin-top: 48px; margin-bottom: 48px;"
>
  <div style="background: #ffffff; border: 1px solid #e1e3e5; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px; flex-wrap: wrap; gap: 20px;">
      <!-- Stats Container -->
      <div id="review-stats-container" style="flex: 1; min-width: 280px; box-sizing: border-box;">
        <h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #111827;">Customer Reviews</h3>

        <div style="display: flex; gap: 24px; align-items: flex-start;">
          <!-- Left: Avg -->
          <div style="text-align: left;">
            <div style="display: flex; gap: 2px; margin-bottom: 4px; color: #fbbf24;" id="avg-rating-stars">
              <!-- Stars JS -->
            </div>
            <div style="font-size: 14px; color: #6b7280;">Based on <span id="total-reviews-count">0</span></div>
            <div style="font-size: 36px; font-weight: 700; color: #111827; line-height: 1;" id="avg-rating-value">
              0.0
            </div>
          </div>

          <!-- Middle: Bars -->
          <div style="flex: 1; max-width: 300px;" id="rating-bars">
            <!-- Bars JS -->
          </div>
        </div>
      </div>

      <!-- Right: Button -->
      <div style="align-self: flex-start; margin-top: 8px;">
        {% if customer %}
          <button
            id="btn-show-review-form"
            class="button"
            style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; border: none; padding: 12px 24px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px -2px rgba(59, 130, 246, 0.4)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(59, 130, 246, 0.3)';"
          >
            <i class="fa-solid fa-star" style="margin-right: 6px;"></i>
            Write a Review
          </button>
        {% else %}
          <a
            href="{{ routes.account_login_url }}"
            class="button"
            style="text-decoration: none; background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 12px 24px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: inline-block;"
          >
            <i class="fa-solid fa-right-to-bracket" style="margin-right: 6px;"></i>
            Login to Review
          </a>
        {% endif %}
      </div>
    </div>

    <div id="reviews-list">
      <div style="text-align: center; padding: 20px; color: #6b7280;">Loading reviews...</div>
    </div>
  </div>
</div>

<!-- Review Modal -->
{% if customer %}
  <div id="review-modal" class="review-modal">
    <div class="review-modal-content">
      <div class="review-modal-header">
        <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #111827;">
          <i class="fa-solid fa-pen-to-square" style="margin-right: 8px; color: #3b82f6;"></i>
          Write Your Review
        </h3>
        <button class="modal-close-btn" id="modal-close-btn">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="review-modal-body">
        <div id="reply-banner-container"></div>

        <form id="review-form">
          <div class="form-group">
            <label class="form-label">
              <i class="fa-solid fa-user" style="margin-right: 6px; color: #6b7280;"></i>
              Your Name
            </label>
            <input
              type="text"
              name="customerName"
              required
              value="{{ customer.name | default: customer.email }}"
              readonly
              class="form-input"
              style="background: #f9fafb; cursor: not-allowed; color: #6b7280;"
            >
            <input type="hidden" name="customerId" value="{{ customer.id }}">
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fa-solid fa-star" style="margin-right: 6px; color: #fbbf24;"></i>
              Rating
            </label>
            <div class="star-rating-input">
              <input type="radio" id="star5" name="rating" value="5">
              <label for="star5"><i class="fa-solid fa-star"></i></label>
              <input type="radio" id="star4" name="rating" value="4">
              <label for="star4"><i class="fa-solid fa-star"></i></label>
              <input type="radio" id="star3" name="rating" value="3">
              <label for="star3"><i class="fa-solid fa-star"></i></label>
              <input type="radio" id="star2" name="rating" value="2">
              <label for="star2"><i class="fa-solid fa-star"></i></label>
              <input type="radio" id="star1" name="rating" value="1">
              <label for="star1"><i class="fa-solid fa-star"></i></label>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fa-solid fa-message" style="margin-right: 6px; color: #6b7280;"></i>
              Your Review
            </label>
            <textarea
              name="comment"
              required
              placeholder="Share your experience with this product..."
              class="form-textarea"
            ></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fa-solid fa-images" style="margin-right: 6px; color: #6b7280;"></i>
              Add Photos (Optional)
            </label>
            <div class="file-upload-wrapper">
              <input
                type="file"
                name="files"
                id="file-upload"
                multiple
                accept="image/*"
                style="display: none;"
              >
              <label for="file-upload" class="file-upload-label" id="file-upload-label">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 20px;"></i>
                <span class="file-text">Click to upload images (Max 5 files, 30MB total)</span>
              </label>
            </div>
          </div>

          <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button type="submit" class="btn-primary" style="flex: 1;">
              <i class="fa-solid fa-paper-plane" style="margin-right: 6px;"></i>
              Submit Review
            </button>
            <button type="button" id="btn-cancel-review" class="btn-secondary">Cancel</button>
          </div>
        </form>

        <div
          id="review-submit-status"
          style="margin-top: 16px; font-weight: 500; text-align: center; min-height: 24px;"
        ></div>
      </div>
    </div>
  </div>
{% endif %}

<script>
  (function () {
    const container = document.getElementById('app-product-reviews');
    if (!container) return;

    const productId = 'gid://shopify/Product/' + container.dataset.productId;
    const productName = container.dataset.productName;
    const shop = container.dataset.shop;
    
    // Using Ngrok URL from .env (Manual update or assume build process replaces this if set up)
    const API_URL = 'https://19accc61e9c3.ngrok-free.app/api'; 

    let replyingToId = null;

    // Helper to fetch with Ngrok skip header
    async function fetchApi(endpoint, options = {}) {
      const url = endpoint.startsWith('http') ? endpoint : `${API_URL}${endpoint}`;
      const defaultHeaders = {
        'ngrok-skip-browser-warning': 'true'
      };
      
      const config = {
        ...options,
        headers: {
          ...defaultHeaders,
          ...options.headers
        }
      };
      
      return fetch(url, config);
    }

    // Modal Controls
    const modal = document.getElementById('review-modal');
    const btnShow = document.getElementById('btn-show-review-form');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const btnCancel = document.getElementById('btn-cancel-review');
    const form = document.getElementById('review-form');
    const statusDiv = document.getElementById('review-submit-status');
    const fileInput = document.getElementById('file-upload');
    const fileLabel = document.getElementById('file-upload-label');

    function openModal() {
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal() {
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        if (form) form.reset();
        cancelReply();
        if (statusDiv) statusDiv.innerHTML = '';
        updateFileLabel();
      }
    }

    if (btnShow) btnShow.addEventListener('click', openModal);
    if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
    if (btnCancel) btnCancel.addEventListener('click', closeModal);

    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    // File upload handling
    function updateFileLabel() {
      if (!fileInput || !fileLabel) return;
      const fileText = fileLabel.querySelector('.file-text');
      if (fileInput.files.length > 0) {
        fileLabel.classList.add('has-files');
        fileText.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${fileInput.files.length} image${fileInput.files.length > 1 ? 's' : ''} selected`;
      } else {
        fileLabel.classList.remove('has-files');
        fileText.innerHTML = 'Click to upload images (Max 5 files, 30MB total)';
      }
    }

    if (fileInput) fileInput.addEventListener('change', updateFileLabel);

    // 0. Fetch Stats
    async function loadStats() {
      const statsContainer = document.getElementById('review-stats-container');
      if (!statsContainer) return;

      try {
        const res = await fetchApi(`/reviews/stats?shop=${shop}&productId=${productId}`);
        if (!res.ok) throw new Error('Failed to load stats');
        const json = await res.json();
        const stats = json.data;

        document.getElementById('avg-rating-value').textContent = stats.averageRating.toFixed(1);
        document.getElementById('total-reviews-count').textContent = stats.totalReviews + ' reviews';

        const avgStars = document.getElementById('avg-rating-stars');
        avgStars.innerHTML = Array(5).fill(0).map((_, i) =>
          `<i class="fa-solid fa-star" style="color: ${i < Math.round(stats.averageRating) ? '#fbbf24' : '#e5e7eb'}; font-size: 18px;"></i>`
        ).join('');

        const totalReviews = stats.totalReviews && stats.totalReviews > 0 ? parseInt(stats.totalReviews) : 1;
        const createBar = (star, count) => {
          const safeCount = count || 0;
          const pct = (safeCount / totalReviews) * 100;
          return `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span style="width: 30px; font-size: 13px; color: #4b5563;">${star} <i class="fa-solid fa-star" style="font-size: 10px; color: #fbbf24;"></i></span>
                <div style="flex: 1; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">
                    <div style="display: block; height: 100%; width: ${pct}%; background-color: #10b981; border-radius: 4px; transition: width 0.3s ease;"></div>
                </div>
                <span style="width: 20px; font-size: 13px; color: #6b7280; text-align: right;">${safeCount}</span>
            </div>`;
        };

        const barsHtml = `
          ${createBar(5, stats.fiveStars)}
          ${createBar(4, stats.fourStars)}
          ${createBar(3, stats.threeStars)}
          ${createBar(2, stats.twoStars)}
          ${createBar(1, stats.oneStar)}
        `;
        document.getElementById('rating-bars').innerHTML = barsHtml;
      } catch (e) {
        console.error(e);
      }
    }

    // 1. Fetch Reviews
    async function loadReviews() {
      const listContainer = document.getElementById('reviews-list');
      loadStats();

      try {
        const res = await fetchApi(`/reviews?shop=${shop}&productId=${productId}`);
        if (!res.ok) throw new Error('Failed to load');
        const json = await res.json();
        const allReviews = json.data.content;

        if (allReviews.length === 0) {
          listContainer.innerHTML = `
          <div style="text-align: center; padding: 40px 0; color: #6b7280;">
            <i class="fa-regular fa-comments" style="font-size: 48px; color: #d1d5db; margin-bottom: 16px;"></i>
            <p style="margin: 0; font-size: 16px; font-weight: 500;">No reviews yet.</p>
            <p style="margin: 8px 0 0 0; font-size: 14px;">Be the first to share your experience!</p>
          </div>`;
          return;
        }

        const parents = allReviews.filter((r) => !r.replyTo);
        const replies = allReviews.filter((r) => r.replyTo);

        const renderReview = (r, isReply = false) => {
          const stars = Array(5).fill(0).map((_, i) =>
            `<i class="fa-solid fa-star" style="color: ${i < r.rating ? '#fbbf24' : '#e5e7eb'}; font-size: 14px;"></i>`
          ).join('');

          return `
            <div style="${isReply ? 'margin-left: 48px; border-left: 3px solid #dbeafe; padding-left: 16px; background: #f0f9ff;' : 'border-bottom: 1px solid #f3f4f6; padding-bottom: 20px;'} margin-bottom: 20px; padding: 16px; border-radius: 8px;">
              <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 12px;">
                 <div style="display:flex; align-items:center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 16px; box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);">
                        ${(r.customerName || 'A').charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <strong style="color: #111827; font-size: 15px; display:block;">${r.customerName || 'Anonymous'}</strong>
                        <small style="color: #9ca3af; font-size: 12px;">${new Date(r.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</small>
                    </div>
                    ${isReply ? '<span style="font-size: 11px; color: #2563eb; background: #dbeafe; padding: 3px 8px; border-radius: 4px; font-weight: 600; margin-left: 8px;">REPLY</span>' : ''}
                 </div>
                 <div style="display: flex; gap: 4px;">${!isReply && r.rating ? stars : ''}</div>
              </div>
              <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6; font-size: 15px;">${r.comment}</p>
              ${r.media && r.media.length ? `
                 <div style="display:flex; gap:12px; overflow-x:auto; padding-bottom: 8px; margin-top: 12px;">
                   ${r.media.map((m) => m.mediaType === 'IMAGE' ? 
                     `<img src="${API_URL.replace('/api', '')}${m.mediaUrl}" style="height:100px; width: 100px; object-fit: cover; border-radius: 12px; border: 2px solid #e5e7eb; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" />` : 
                     `<video src="${API_URL.replace('/api', '')}${m.mediaUrl}" style="height:100px; border-radius: 12px;" controls></video>`
                   ).join('')}
                 </div>` : ''}
              ${!isReply && modal ? `<div style="margin-top: 12px;"><button class="btn-reply" data-id="${r.id}" data-name="${r.customerName || 'Anonymous'}" style="background: #eff6ff; border: 1px solid #bfdbfe; color: #2563eb; font-size: 13px; font-weight: 600; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;"><i class="fa-solid fa-reply"></i> Reply</button></div>` : ''}
            </div>`;
        };

        const html = parents.map((p) => {
            const pReplies = replies.filter((r) => r.replyTo === p.id);
            pReplies.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            return renderReview(p) + pReplies.map((r) => renderReview(r, true)).join('');
          }).join('');

        listContainer.innerHTML = html;
        listContainer.querySelectorAll('.btn-reply').forEach((btn) => {
          btn.addEventListener('click', (e) => startReply(btn.dataset.id, btn.dataset.name));
        });
      } catch (e) {
        console.error(e);
        listContainer.innerHTML = '<p style="color:#ef4444; text-align: center; padding: 20px;">Error loading reviews.</p>';
      }
    }

    // Reply Logic
    function startReply(id, name) {
      replyingToId = id;
      openModal();
      const ratingGroup = form.querySelector('.star-rating-input').closest('.form-group');
      if (ratingGroup) ratingGroup.style.display = 'none';

      const bannerContainer = document.getElementById('reply-banner-container');
      if (bannerContainer) {
        bannerContainer.innerHTML = `<div class="reply-banner"><span><i class="fa-solid fa-reply" style="margin-right: 6px;"></i>Replying to <strong>${name}</strong></span><button type="button" class="cancel-reply-btn" id="btn-cancel-reply-banner">Ã—</button></div>`;
        document.getElementById('btn-cancel-reply-banner').onclick = cancelReply;
      }
    }

    function cancelReply() {
      replyingToId = null;
      const ratingGroup = form.querySelector('.star-rating-input').closest('.form-group');
      if (ratingGroup) ratingGroup.style.display = 'block';
      const bannerContainer = document.getElementById('reply-banner-container');
      if (bannerContainer) bannerContainer.innerHTML = '';
    }

    // Form Submit
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        if (statusDiv) statusDiv.innerHTML = '<span style="color: #3b82f6;"><i class="fa-solid fa-spinner fa-spin"></i> Submitting...</span>';
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = true;

        const ratingInput = form.querySelector('input[name="rating"]:checked');
        let ratingVal = ratingInput ? parseInt(ratingInput.value) : 5;
        if (replyingToId) ratingVal = null;

        try {
          const mediaItems = [];
          if (fileInput.files.length > 0) {
            if (fileInput.files.length > 5) throw new Error('You can only upload a maximum of 5 images.');
            let totalSize = 0;
            const MAX_SIZE = 30 * 1024 * 1024;
            for (let i = 0; i < fileInput.files.length; i++) {
              const file = fileInput.files[i];
              if (!file.type.startsWith('image/')) throw new Error(`File ${file.name} is not an image.`);
              totalSize += file.size;
            }
            if (totalSize > MAX_SIZE) throw new Error('Total file size exceeds 30MB limit.');

            const uploadData = new FormData();
            for (let i = 0; i < fileInput.files.length; i++) {
               uploadData.append('files', fileInput.files[i]);
            }

            const uploadRes = await fetchApi('/files/upload', { method: 'POST', body: uploadData });
            if (!uploadRes.ok) {
              const errorJson = await uploadRes.json();
              throw new Error(errorJson.message || 'Upload failed');
            }
            const uploadJson = await uploadRes.json();
            uploadJson.data.forEach((url) => mediaItems.push({ url: url, type: 'IMAGE', fileSize: 0 }));
          }

          const reviewPayload = {
            productId: productId,
            productName: productName,
            customerName: formData.get('customerName'),
            rating: ratingVal,
            comment: formData.get('comment'),
            replyTo: replyingToId,
            media: mediaItems,
          };

          const res = await fetchApi(`/reviews?shop=${shop}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reviewPayload),
          });

          if (!res.ok) throw new Error('Review submission failed');

          if (statusDiv) statusDiv.innerHTML = '<span style="color: #10b981;"><i class="fa-solid fa-circle-check"></i> Review submitted successfully!</span>';
          setTimeout(() => {
            closeModal();
            loadReviews();
            if (submitBtn) submitBtn.disabled = false;
          }, 1500);
        } catch (err) {
          console.error(err);
          if (statusDiv) statusDiv.innerHTML = `<span style="color: #ef4444;"><i class="fa-solid fa-circle-exclamation"></i> ${err.message}</span>`;
          if (submitBtn) submitBtn.disabled = false;
        }
      });
    }

    // Init
    loadReviews();
  })();
</script>

{% schema %}
{
  "name": "Product Reviews",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "paragraph",
      "content": "Displays reviews. Requires customer login to submit."
    }
  ]
}
{% endschema %}
