{% comment %}
  Product Reviews Block
  Allows users to view and submit reviews.
  Requires Login for submission.
  Uses FontAwesome for icons.
{% endcomment %}

<!-- FontAwesome CDN -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
>

<!-- Google reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>

<style>
  /* Modal Styles */
  .review-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 9999;
    overflow-y: auto;
    animation: fadeIn 0.2s ease;
  }

  .review-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .review-modal-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideUp 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .review-modal-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: white;
    border-radius: 16px 16px 0 0;
    z-index: 1;
  }

  .review-modal-body {
    padding: 24px;
  }

  .modal-close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #6b7280;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
  }

  .modal-close-btn:hover {
    background: #f3f4f6;
    color: #111827;
  }

  .star-rating-input {
    display: flex;
    gap: 8px;
    flex-direction: row-reverse;
    justify-content: flex-end;
  }

  .star-rating-input input {
    display: none;
  }

  .star-rating-input label {
    cursor: pointer;
    color: #d1d5db;
    font-size: 32px;
    transition: all 0.2s;
  }

  .star-rating-input label:hover,
  .star-rating-input label:hover ~ label,
  .star-rating-input input:checked ~ label {
    color: #fbbf24 !important;
    transform: scale(1.1);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
    font-size: 14px;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s;
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-textarea {
    resize: vertical;
    min-height: 100px;
  }

  .file-upload-wrapper {
    position: relative;
  }

  .file-upload-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 20px;
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    background: #f9fafb;
    color: #6b7280;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .file-upload-label:hover {
    border-color: #3b82f6;
    background: #eff6ff;
    color: #3b82f6;
  }

  .file-upload-label.has-files {
    border-color: #10b981;
    background: #f0fdf4;
    color: #10b981;
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    padding: 12px 32px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 15px;
    transition: all 0.2s;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px -2px rgba(59, 130, 246, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .btn-secondary {
    background: white;
    color: #6b7280;
    border: 2px solid #e5e7eb;
    padding: 12px 32px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 15px;
    transition: all 0.2s;
  }

  .btn-secondary:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  @media (max-width: 640px) {
    .review-modal-content {
      max-height: 100vh;
      border-radius: 0;
    }

    .review-modal-header {
      border-radius: 0;
    }
  }
</style>

<div
  id="app-product-reviews"
  data-product-id="{{ product.id }}"
  data-product-name="{{ product.title | escape }}"
  data-shop="{{ shop.permanent_domain }}"
  style="margin-top: 48px; margin-bottom: 48px;"
>
  <div style="background: #ffffff; border: 1px solid #e1e3e5; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px; flex-wrap: wrap; gap: 20px;">
      <!-- Stats Container -->
      <div id="review-stats-container" style="flex: 1; min-width: 280px; box-sizing: border-box;">
        <h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #111827;">Customer Reviews</h3>

        <div style="display: flex; gap: 24px; align-items: flex-start;">
          <!-- Left: Avg -->
          <div style="text-align: left;">
            <div style="display: flex; gap: 2px; margin-bottom: 4px; color: #fbbf24;" id="avg-rating-stars">
              <!-- Stars JS -->
            </div>
            <div style="font-size: 14px; color: #6b7280;">Based on <span id="total-reviews-count">0</span></div>
            <div style="font-size: 36px; font-weight: 700; color: #111827; line-height: 1;" id="avg-rating-value">
              0.0
            </div>
          </div>

          <!-- Middle: Bars -->
          <div style="flex: 1; max-width: 300px;" id="rating-bars">
            <!-- Bars JS -->
          </div>
        </div>
      </div>

      <!-- Right: Button -->
      <div style="align-self: flex-start; margin-top: 8px;">
        {% if customer %}
          <button
            id="btn-show-review-form"
            class="button"
            style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; border: none; padding: 12px 24px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px -2px rgba(59, 130, 246, 0.4)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(59, 130, 246, 0.3)';"
          >
            <i class="fa-solid fa-star" style="margin-right: 6px;"></i>
            Write a Review
          </button>
        {% else %}
          <a
            href="{{ routes.account_login_url }}"
            class="button"
            style="text-decoration: none; background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 12px 24px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: inline-block;"
          >
            <i class="fa-solid fa-right-to-bracket" style="margin-right: 6px;"></i>
            Login to Review
          </a>
        {% endif %}
      </div>
    </div>

    <div id="reviews-list">
      <div style="text-align: center; padding: 20px; color: #6b7280;">Loading reviews...</div>
    </div>
  </div>
</div>

<!-- Review Modal -->
{% if customer %}
  <div id="review-modal" class="review-modal">
    <div class="review-modal-content">
      <div class="review-modal-header">
        <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #111827;">
          <i class="fa-solid fa-pen-to-square" style="margin-right: 8px; color: #3b82f6;"></i>
          Write Your Review
        </h3>
        <button class="modal-close-btn" id="modal-close-btn">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="review-modal-body">
        <form id="review-form">
          <div class="form-group">
            <label class="form-label">
              <i class="fa-solid fa-user" style="margin-right: 6px; color: #6b7280;"></i>
              Your Name
            </label>
            <input
              type="text"
              name="customerName"
              required
              value="{{ customer.name | default: customer.email }}"
              readonly
              class="form-input"
              style="background: #f9fafb; cursor: not-allowed; color: #6b7280;"
            >
            <input type="hidden" name="customerId" value="{{ customer.id }}">
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fa-solid fa-star" style="margin-right: 6px; color: #fbbf24;"></i>
              Rating
            </label>
            <div class="star-rating-input">
              <input type="radio" id="star5" name="rating" value="5">
              <label for="star5"><i class="fa-solid fa-star"></i></label>
              <input type="radio" id="star4" name="rating" value="4">
              <label for="star4"><i class="fa-solid fa-star"></i></label>
              <input type="radio" id="star3" name="rating" value="3">
              <label for="star3"><i class="fa-solid fa-star"></i></label>
              <input type="radio" id="star2" name="rating" value="2">
              <label for="star2"><i class="fa-solid fa-star"></i></label>
              <input type="radio" id="star1" name="rating" value="1">
              <label for="star1"><i class="fa-solid fa-star"></i></label>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fa-solid fa-message" style="margin-right: 6px; color: #6b7280;"></i>
              Your Review
            </label>
            <textarea
              name="comment"
              required
              placeholder="Share your experience with this product..."
              class="form-textarea"
            ></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fa-solid fa-images" style="margin-right: 6px; color: #6b7280;"></i>
              Add Photos (Optional)
            </label>
            <div class="file-upload-wrapper">
              <input
                type="file"
                name="files"
                id="file-upload"
                multiple
                accept="image/*"
                style="display: none;"
              >
              <label for="file-upload" class="file-upload-label" id="file-upload-label">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 20px;"></i>
                <span class="file-text">Click to upload images (Max 5 files, 30MB total)</span>
              </label>
            </div>
          </div>

          <div class="form-group" style="margin-top: 16px; display: flex; align-items: center; gap: 8px;">
            <input
              type="checkbox"
              name="isAnonymous"
              id="is-anonymous-checkbox"
              style="width: 18px; height: 18px; cursor: pointer;"
            >
            <label for="is-anonymous-checkbox" style="font-size: 14px; color: #374151; cursor: pointer;"
              >Post as Anonymous</label
            >
          </div>

          <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button type="submit" class="btn-primary" style="flex: 1;">
              <i class="fa-solid fa-paper-plane" style="margin-right: 6px;"></i>
              Submit Review
            </button>
            <button type="button" id="btn-cancel-review" class="btn-secondary">Cancel</button>
          </div>
        </form>

        <div
          id="review-submit-status"
          style="margin-top: 16px; font-weight: 500; text-align: center; min-height: 24px;"
        ></div>
      </div>
    </div>
  </div>
{% endif %}

<!-- Captcha Verification Modal -->
<div id="captcha-modal" class="review-modal">
  <div class="review-modal-content" style="max-width: 400px; padding: 32px 24px; text-align: center;">
    <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: #111827;">Security Check</h3>
    <p style="margin: 0 0 24px 0; color: #6b7280; font-size: 14px;">
      Please complete the verification below to submit your review.
    </p>

    <div style="display: flex; justify-content: center; margin-bottom: 24px;">
      <div id="recaptcha-widget"></div>
    </div>

    <button id="btn-cancel-captcha" class="btn-secondary" style="width: 100%;">Cancel</button>
  </div>
</div>

<!-- Thank You Modal -->
<div id="thank-you-modal" class="review-modal">
  <div class="review-modal-content" style="max-width: 400px; text-align: center; padding: 40px 24px;">
    <div style="width: 80px; height: 80px; background: #f0fdf4; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: #10b981; font-size: 40px;">
      <i class="fa-solid fa-circle-check"></i>
    </div>
    <h3 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 700; color: #111827;">Thank You!</h3>
    <p style="margin: 0 0 32px 0; color: #4b5563; line-height: 1.6; font-size: 15px;">
      Your review has been submitted successfully. It will be reviewed by our team and published shortly.
    </p>
    <button id="btn-close-thanks" class="btn-primary" style="width: 100%;">Close</button>
  </div>
</div>

<script>
  (function () {
    const container = document.getElementById('app-product-reviews');
    if (!container) return;

    const productId = 'gid://shopify/Product/' + container.dataset.productId;
    const productName = container.dataset.productName;
    const shop = container.dataset.shop;

    const API_URL = 'https://cf9506a7798e.ngrok-free.app/api';
    const RECAPTCHA_SITE_KEY = '6LdAx1osAAAAAEqjehGbSgDvERxdVwPKDUcgxOrn';

    // Helper to fetch with Ngrok skip header
    async function fetchApi(endpoint, options = {}) {
      const url = endpoint.startsWith('http') ? endpoint : `${API_URL}${endpoint}`;
      const defaultHeaders = {
        'ngrok-skip-browser-warning': 'true',
      };

      const config = {
        ...options,
        headers: {
          ...defaultHeaders,
          ...options.headers,
        },
      };

      return fetch(url, config);
    }

    // Modal Controls
    const modal = document.getElementById('review-modal');
    const btnShow = document.getElementById('btn-show-review-form');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const btnCancel = document.getElementById('btn-cancel-review');
    const form = document.getElementById('review-form');
    const statusDiv = document.getElementById('review-submit-status');
    const fileInput = document.getElementById('file-upload');
    const fileLabel = document.getElementById('file-upload-label');
    const thankYouModal = document.getElementById('thank-you-modal');
    const btnCloseThanks = document.getElementById('btn-close-thanks');

    // Captcha elements
    const captchaModal = document.getElementById('captcha-modal');
    const btnCancelCaptcha = document.getElementById('btn-cancel-captcha');

    let pendingReviewPayload = null; // Store payload while waiting for captcha

    // Initialize Recaptcha
    window.onloadCallback = function () {
      if (RECAPTCHA_SITE_KEY && document.getElementById('recaptcha-widget')) {
        grecaptcha.render('recaptcha-widget', {
          sitekey: RECAPTCHA_SITE_KEY,
          callback: onCaptchaSolved,
        });
      }
    };

    function openModal() {
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal() {
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        if (form) form.reset();
        if (statusDiv) statusDiv.innerHTML = '';
        updateFileLabel();
      }
    }

    function openThanks() {
      if (thankYouModal) {
        thankYouModal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeThanks() {
      if (thankYouModal) {
        thankYouModal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    if (btnShow) btnShow.addEventListener('click', openModal);
    if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
    if (btnCancel) btnCancel.addEventListener('click', closeModal);

    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    if (thankYouModal) {
      thankYouModal.addEventListener('click', (e) => {
        if (e.target === thankYouModal) closeThanks();
      });
    }

    if (btnCloseThanks) btnCloseThanks.addEventListener('click', closeThanks);

    if (btnCancelCaptcha) {
      btnCancelCaptcha.addEventListener('click', () => {
        captchaModal.classList.remove('active');
        document.body.style.overflow = '';
        grecaptcha.reset();
        if (form.querySelector('button[type="submit"]')) {
          form.querySelector('button[type="submit"]').disabled = false;
        }
      });
    }

    // Global callback for reCAPTCHA
    window.onCaptchaSolved = function (token) {
      if (token && pendingReviewPayload) {
        pendingReviewPayload.captchaToken = token;
        executeSubmission(pendingReviewPayload);
      }
    };

    // File upload handling
    function updateFileLabel() {
      if (!fileInput || !fileLabel) return;
      const fileText = fileLabel.querySelector('.file-text');
      if (fileInput.files.length > 0) {
        fileLabel.classList.add('has-files');
        fileText.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${fileInput.files.length} image${
          fileInput.files.length > 1 ? 's' : ''
        } selected`;
      } else {
        fileLabel.classList.remove('has-files');
        fileText.innerHTML = 'Click to upload images (Max 5 files, 30MB total)';
      }
    }

    if (fileInput) fileInput.addEventListener('change', updateFileLabel);

    // 0. Fetch Stats
    async function loadStats() {
      const statsContainer = document.getElementById('review-stats-container');
      if (!statsContainer) return;

      try {
        const res = await fetchApi(`/reviews/stats?shop=${shop}&productId=${productId}&status=true`);
        if (!res.ok) throw new Error('Failed to load stats');
        const json = await res.json();
        const stats = json.data;

        document.getElementById('avg-rating-value').textContent = stats.averageRating.toFixed(1);
        document.getElementById('total-reviews-count').textContent = stats.totalReviews + ' reviews';

        const avgStars = document.getElementById('avg-rating-stars');
        avgStars.innerHTML = Array(5)
          .fill(0)
          .map(
            (_, i) =>
              `<i class="fa-solid fa-star" style="color: ${
                i < Math.round(stats.averageRating) ? '#fbbf24' : '#e5e7eb'
              }; font-size: 18px;"></i>`
          )
          .join('');

        const totalReviews = stats.totalReviews && stats.totalReviews > 0 ? parseInt(stats.totalReviews) : 1;
        const createBar = (star, count) => {
          const safeCount = count || 0;
          const pct = (safeCount / totalReviews) * 100;
          return `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span style="width: 30px; font-size: 13px; color: #4b5563;">${star} <i class="fa-solid fa-star" style="font-size: 10px; color: #fbbf24;"></i></span>
                <div style="flex: 1; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden;">
                    <div style="display: block; height: 100%; width: ${pct}%; background-color: #10b981; border-radius: 4px; transition: width 0.3s ease;"></div>
                </div>
                <span style="width: 20px; font-size: 13px; color: #6b7280; text-align: right;">${safeCount}</span>
            </div>`;
        };

        const barsHtml = `
          ${createBar(5, stats.fiveStars)}
          ${createBar(4, stats.fourStars)}
          ${createBar(3, stats.threeStars)}
          ${createBar(2, stats.twoStars)}
          ${createBar(1, stats.oneStar)}
        `;
        document.getElementById('rating-bars').innerHTML = barsHtml;
      } catch (e) {
        console.error(e);
      }
    }

    // 1. Fetch Reviews
    async function loadReviews() {
      const listContainer = document.getElementById('reviews-list');
      loadStats();

      try {
        const res = await fetchApi(`/reviews?shop=${shop}&productId=${productId}&status=true`);
        if (!res.ok) throw new Error('Failed to load');
        const json = await res.json();
        const allReviews = json.data.content;

        if (allReviews.length === 0) {
          listContainer.innerHTML = `
          <div style="text-align: center; padding: 40px 0; color: #6b7280;">
            <i class="fa-regular fa-comments" style="font-size: 48px; color: #d1d5db; margin-bottom: 16px;"></i>
            <p style="margin: 0; font-size: 16px; font-weight: 500;">No reviews yet.</p>
            <p style="margin: 8px 0 0 0; font-size: 14px;">Be the first to share your experience!</p>
          </div>`;
          return;
        }

        const renderReview = (r) => {
          const isAnonymous = r.isAnonymous === true;

          const displayName = r.customerName;
          const isPinned = r.isPinned === true;
          const stars = Array(5)
            .fill(0)
            .map(
              (_, i) =>
                `<i class="fa-solid fa-star" style="color: ${
                  i < r.rating ? '#fbbf24' : '#e5e7eb'
                }; font-size: 14px;"></i>`
            )
            .join('');

          return `
             <div style="border-bottom: 1px solid #f3f4f6; padding-bottom: 20px; margin-bottom: 20px;">
               <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 12px;">
                  <div style="display:flex; align-items:center; gap: 12px;">
                     <div style="width: 40px; height: 40px; background: ${
                       isAnonymous ? '#9ca3af' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                     }; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                         ${displayName.charAt(0).toUpperCase()}
                     </div>
                     <div>
                         <strong style="color: #111827; font-size: 15px; display:block; display: flex; align-items: center; gap: 8px;">
                            ${displayName}
                         </strong>
                         <small style="color: #9ca3af; font-size: 12px;">${new Date(r.createdAt).toLocaleDateString(
                           'en-US',
                           { year: 'numeric', month: 'short', day: 'numeric' }
                         )}</small>
                     </div>
                  </div>
                  <div style="display: flex; gap: 4px;">${r.rating ? stars : ''}</div>
               </div>
               <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6; font-size: 15px;">${r.comment}</p>
               ${
                 r.media && r.media.length
                   ? `
                  <div style="display:flex; gap:12px; overflow-x:auto; padding-bottom: 8px; margin-top: 12px;">
                    ${r.media
                      .map((m) =>
                        m.mediaType === 'IMAGE'
                          ? `<img src="${API_URL.replace('/api', '')}${
                              m.mediaUrl
                            }" style="height:100px; width: 100px; object-fit: cover; border-radius: 12px; border: 2px solid #e5e7eb; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" />`
                          : `<video src="${API_URL.replace('/api', '')}${
                              m.mediaUrl
                            }" style="height:100px; border-radius: 12px;" controls></video>`
                      )
                      .join('')}
                  </div>`
                   : ''
               }
               
               ${
                 r.reply
                   ? `
                  <div style="margin-top: 16px; padding: 16px; background: #e0f7f9; border-radius: 12px; position: relative;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; color: #086c7e;">
                      <i class="fa-solid fa-reply" style="font-size: 14px; transform: scaleX(-1);"></i>
                      <strong style="font-size: 13px; font-weight: 600;">Shop reply</strong>
                    </div>
                    <p style="margin: 0; font-size: 14px; color: #374151; line-height: 1.5; padding-left: 24px;">${r.reply}</p>
                    <div style="position: absolute; top: 12px; right: 16px; color: #9ca3af; cursor: pointer;">
                      <i class="fa-solid fa-ellipsis"></i>
                    </div>
                  </div>`
                   : ''
               }
             </div>`;
        };

        const html = allReviews.map((r) => renderReview(r)).join('');
        listContainer.innerHTML = html;
      } catch (e) {
        console.error(e);
        listContainer.innerHTML =
          '<p style="color:#ef4444; text-align: center; padding: 20px;">Error loading reviews.</p>';
      }
    }

    async function executeSubmission(payload) {
      const submitBtn = form.querySelector('button[type="submit"]');

      try {
        const res = await fetchApi(`/reviews?shop=${shop}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error('Review submission failed');

        // Success flow
        if (captchaModal) captchaModal.classList.remove('active');
        if (statusDiv)
          statusDiv.innerHTML =
            '<span style="color: #10b981;"><i class="fa-solid fa-circle-check"></i> Review submitted successfully!</span>';

        setTimeout(() => {
          closeModal();
          openThanks();
          if (submitBtn) submitBtn.disabled = false;
          pendingReviewPayload = null;
          grecaptcha.reset();
        }, 1000);
      } catch (err) {
        console.error(err);
        if (captchaModal) captchaModal.classList.remove('active');
        if (statusDiv)
          statusDiv.innerHTML = `<span style="color: #ef4444;"><i class="fa-solid fa-circle-exclamation"></i> ${err.message}</span>`;
        if (submitBtn) submitBtn.disabled = false;
        grecaptcha.reset();
      }
    }

    // Updated Submit Handler to show Captcha Popup
    if (form) {
      form.onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');

        const ratingInput = form.querySelector('input[name="rating"]:checked');
        if (!ratingInput) {
          alert('Please select a rating.');
          return;
        }
        let ratingVal = parseInt(ratingInput.value);

        if (statusDiv)
          statusDiv.innerHTML =
            '<span style="color: #3b82f6;"><i class="fa-solid fa-spinner fa-spin"></i> Preparing...</span>';
        if (submitBtn) submitBtn.disabled = true;

        try {
          const mediaItems = [];
          if (fileInput.files.length > 0) {
            // ... (file validation logic remains same)
            if (fileInput.files.length > 5) throw new Error('You can only upload a maximum of 5 images.');
            let totalSize = 0;
            const MAX_SIZE = 30 * 1024 * 1024;
            for (let i = 0; i < fileInput.files.length; i++) {
              totalSize += fileInput.files[i].size;
            }
            if (totalSize > MAX_SIZE) throw new Error('Total file size exceeds 30MB limit.');

            const uploadData = new FormData();
            for (let i = 0; i < fileInput.files.length; i++) {
              uploadData.append('files', fileInput.files[i]);
            }

            const uploadRes = await fetchApi('/files/upload', { method: 'POST', body: uploadData });
            if (!uploadRes.ok) throw new Error('Upload failed');
            const uploadJson = await uploadRes.json();
            uploadJson.data.forEach((url) => mediaItems.push({ url: url, type: 'IMAGE', fileSize: 0 }));
          }

          const isAnon = formData.get('isAnonymous') === 'on';
          pendingReviewPayload = {
            productId: productId,
            productName: productName,
            customerName: formData.get('customerName'),
            rating: ratingVal,
            comment: formData.get('comment'),
            isAnonymous: isAnon,
            media: mediaItems,
          };

          // Show captcha modal
          if (captchaModal) {
            captchaModal.classList.add('active');
            if (statusDiv) statusDiv.innerHTML = '<span style="color: #3b82f6;">Verification required...</span>';
          } else {
            // Fail-safe if captcha modal missing for some reason
            executeSubmission(pendingReviewPayload);
          }
        } catch (err) {
          console.error(err);
          if (statusDiv)
            statusDiv.innerHTML = `<span style="color: #ef4444;"><i class="fa-solid fa-circle-exclamation"></i> ${err.message}</span>`;
          if (submitBtn) submitBtn.disabled = false;
        }
      };
    }

    // Init
    loadReviews();
  })();
</script>

{% schema %}
{
  "name": "Product Reviews",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "paragraph",
      "content": "Displays reviews. Requires customer login to submit."
    },
    {
      "type": "paragraph",
      "content": "Displays reviews. Requires customer login to submit."
    }
  ]
}
{% endschema %}
